import { SimpleHandlerConfig } from '../types';
import { JsonValue } from 'type-fest'

type TBinanceKycResponse = {
  code: string;
  success: boolean;
  data: {
    kycStatus: number;
    currentKycLevel: string;
    jumioStatus: string;
    userId: number;
  };
};

export const BinanceKycHandlerConfig: SimpleHandlerConfig = {
  name: 'Binance KYC',
  request: {
    method: 'POST',
    urlPattern:
      'https://www.binance.com/bapi/kyc/v2/private/certificate/user-kyc/current-kyc-status',
  },
  redirect: 'https://www.binance.com/en/my/dashboard',
  tlsnConfig: {
    serverDns: 'www.binance.com',
    maxSentData: 1000,
    maxRecvData: 24000,
  },
  replayRequestCfg: {
    headers: {
      custom: {
        'accept-encoding': 'identity',
        'content-type': 'application/json',
        'clienttype': 'web',
      },
      whitelist: [
        'csrftoken',
        'bnc-uuid'
      ],
      cookie: {
        whitelist: [
          'aws-waf-token',
          'p20t',
          'bnc-uuid',
          'd1og',
          'logined',
          'cr00',
          '__cuid',
          'BNC_FV_KEY',
          'BNC_FV_KEY_T',
          'BNC_FV_KEY_EXPIRE'
        ],
      },
    },
  },
  transcriptDisclose: [
    '/data/kycStatus',
    '/data/currentKycLevel',
    '/data/jumioStatus',
    '/data/userId'
  ],
  responseMiddleware: async (_, response: JsonValue) => {
    const { code, success, data } = response as TBinanceKycResponse;
    console.log({ code, success, data });


    if (code !== '000000' || !success) {
      return new Error('binance_data_not_found');
    }

    if (data?.kycStatus === undefined) {
      return new Error('binance_data_not_found');
    }

    // kycStatus = 1 means verified, jumioStatus = 'PASS' means identity verified
    const kycPassed = data.kycStatus === 1;
    const identityVerified = data.jumioStatus === 'PASS';

    if (!kycPassed || !identityVerified) {
      return new Error('binance_kyc_not_verified');
    }
  },
};




// "***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************"kycStatus":1*************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************"jumioStatus":"PASS"*****************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************"currentKycLevel":"ADVANCED"*****************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************"userId":15323293*****************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************"