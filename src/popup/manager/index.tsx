import IManager, {
  TAddUserKey,
  TInit,
  TRunVerify,
  TSaveVerification,
  TGetProofs,
} from './types';
import getStorage, { DBStorage } from '../db-storage';
import TRunTask from './types/run-task';
import semaphore from '../semaphore';
import verifier from '../verifier';
import relayer from '../relayer';
import { TSemaphoreProof } from '../types';
import { tasks } from '../../common/core';
import { calculateScope } from '../utils';
import { generateProof } from '@semaphore-protocol/core';

class Manager implements IManager {
  #db?: DBStorage;

  constructor() {
    console.log('Manager initialized');
    this.init();
  }

  init: TInit = async () => {
    this.#db = await getStorage();
  };

  addUserKey: TAddUserKey = async (key: string) => {
    await this.#db?.addUserKey(key);
  };

  runTask: TRunTask = async (credentialGroupId) => {
    // presentation data

    return '014000000000000000e8c27a80d10e53f098b40855a5fa40129d5d943ba910bbfa6914b31a3cae3ea841d3b810de699cd78b662168378f0d2ef8e08f1cdecafc91646870b8156f3f26891a3e09a04676d0c8cd99fe1acf6d3d00000000022000000000000000f04c49a62ff15f83fb5ad0cd876dbd66318395099a388ad0b6508b89c411552f000000000121000000000000000307ba0cd5dd87e93f3504f6d047339b9f68f44b7dbb4d3f4b4271a2c8b481b106010000007c169368000000000000000028050000e809000002000000000000004100000000000000047984d35cde54b92f08dca3d9e6fa447f46fb9489b55897ced7383cec7bb93271459d660c37f1c83142e78399878f625f4885d1a2c93bf41277b2dfb3f07af59203000000022000000000000000f9753889147789b9f0a28b5bcaed93ad4cad0ff5aea854ae597f0adf232c5f560000000000000000010000000000000004000000000000000220000000000000002ea7a3ce0d624f764be295a3cfc0cf3697e97d83ad2119b277cd4fe29dc278b22ff2e70031297f703717621556091f545d92fc609cdff824f5d40d8f832301aa7f9309676cdb12d8defc8476f82fb1bc02050000000000000000000000000000000109000000000000006170692e782e636f6d02000000000000009b03000000000000308203973082031ca003020102021205a79fecd4919c51dd1c72fa98ba9d1f4c19300a06082a8648ce3d0403033032310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310b3009060355040313024536301e170d3235303632353137353731305a170d3235303932333137353730395a3010310e300c06035504031305782e636f6d3059301306072a8648ce3d020106082a8648ce3d030107034200044cff77a9df863fb7c418ff1382ca5937405bd8a938548186ca8029603e3d2a35c7e722d1f037bbedc677fe488562520f81e08255a402a72f91e50584f68608afa38202323082022e300e0603551d0f0101ff040403020780301d0603551d250416301406082b0601050507030106082b06010505070302300c0603551d130101ff04023000301d0603551d0e041604145c182144ce7525b7a4443ebcbc5320322a2b2944301f0603551d230418301680149327469803a951688e98d6c44248db23bf5894d2303206082b0601050507010104263024302206082b060105050730028616687474703a2f2f65362e692e6c656e63722e6f72672f30300603551d110429302782072a2e782e636f6d821563646e2e73796e6469636174696f6e2e782e636f6d8205782e636f6d30130603551d20040c300a3008060667810c010201302d0603551d1f042630243022a020a01e861c687474703a2f2f65362e632e6c656e63722e6f72672f32362e63726c30820103060a2b06010401d6790204020481f40481f100ef007500a442c506496061548f0fd4ea9cfb7a2d26454d87a97f2fdf4559f6274f3a845400000197a8721fc20000040300463044022013375b5b45225a44c5df40d2836d89c7a2382bf88293832a12b3c7163d16a3ac02205c636a819b8a54c0e61107c34366cd82a2a021c5568cc3b4ae5b0cc420595f92007600dddcca3495d7e11605e79532fac79ff83d1c50dfdb003a1412760a2cacbbc82a00000197a87220000000040300473045022100c412a956ad49b8447a8046e9ca936b1bf4be1aca36ce78e5cd7ac6242288b27602200c3794967020c5e8b2f00235a9fe25e81b8b689bd203c0f0d727c3532ec0902e300a06082a8648ce3d0403030369003066023100a721111e3fe1fa5301a3917db45419a5e0bd189135a14f50778dfb76297163983690366d82e23805dd1cc4d1add25a51023100aed024f6c7514d51a1e865199883d389a0afa8e05bb60c908ccf6aac5b1a99bf8281f0fb416edb8237276493936fd9f45b04000000000000308204573082023fa003020102021100b0573e9173972770dbb487cb3a452b38300d06092a864886f70d01010b0500304f310b300906035504061302555331293027060355040a1320496e7465726e65742053656375726974792052657365617263682047726f7570311530130603550403130c4953524720526f6f74205831301e170d3234303331333030303030305a170d3237303331323233353935395a3032310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310b30090603550403130245363076301006072a8648ce3d020106052b8104002203620004d9f19e4687f8217160a826eba3fab9eada1db912a7d426d95114b1617c7596bf220b391fd5bed10a46aa2d3c4a09842ebe409555e91940376675ed324e770449f8707bc318e7cef77110feac74d800d4ed6d1c731633109c3ab2ea6c62f4bdb8a381f83081f5300e0603551d0f0101ff040403020186301d0603551d250416301406082b0601050507030206082b0601050507030130120603551d130101ff040830060101ff020100301d0603551d0e041604149327469803a951688e98d6c44248db23bf5894d2301f0603551d2304183016801479b459e67bb6e5e40173800888c81a58f6e99b6e303206082b0601050507010104263024302206082b060105050730028616687474703a2f2f78312e692e6c656e63722e6f72672f30130603551d20040c300a3008060667810c01020130270603551d1f0420301e301ca01aa0188616687474703a2f2f78312e632e6c656e63722e6f72672f300d06092a864886f70d01010b050003820201007d8b7b4a2035b20586088a6e9e4e3aaf8004c4845c33190a81484d96baefd41db584e69737fe66884f8b3936eb72653f33dcaf0ba31563bdf418d1682fc22127c8fcbeb38ba4c636d8e3fa6da4b593d60caed0d3970247a066f2d384e14d47810e4b12f518ae1ef89c66a05e75074817ae6966e86978370605c2e261ab10aff10ee60c71b4bc939a0b0748e55205c14e9fd960bfb2c408fabd8bb99f1f79a9c60ad1292c47a4ea19d0a5cc701fa11eebe59251e7b6f708d2630c4349a1623eaab4c152b64175469086dc83dd230a55090aaef0657bb3cb9b927473b3edc2fc19b5f5114ea223e90e4c2fc8d7ef990d785e4caaa8a2b9a19f33843df69054509316bcb994ae878693226171927bb7f70681c484571388cac6502641ce108c5668ab52a642a420d09ff5245f11945bc96acd557232ef625bd4076b7a9e93baa108c1de5f8f35fd03a501fb894c775b3e408d00a2e8bdb9163c84d3aaba059fd0966b58765ffc6586a8e1246a3c4b3fe9c02217e41fe73836524696b43a619752ca32e4cd2e8b6fb17f7d1cfebd5767da3727a0a1d4342f24c0a6bfef4f4d583c4e3abcdb032e02bee1c2fa4ebcc2fdae1672617949127ddfccebbff76e2472d740892ee6fd3e1303b2e7d1dd9b43d3fc4afff387435740928dd47fd97b99337929cac48a2e00f570a88303e21182e3830b17cef5cc98220e3abfd985981bf21f4e0300000047000000000000003045022100965d83dd619f8b0394fb68f47c3461cc35919e654dced91d5bafaf322b8291a30220710702a46516074d4fb8686ce7f14b1db3ea199308d2262eace821ed5697b7b0000000004b876b67a275df7cacf5470e07a2827312c877c63466bc931851fee9731217846893167d27088da1ac95f63cb14380f17577bc40eff7c0a1444f574e47524401000000004100000000000000047984d35cde54b92f08dca3d9e6fa447f46fb9489b55897ced7383cec7bb93271459d660c37f1c83142e78399878f625f4885d1a2c93bf41277b2dfb3f07af5923e68678ef51d64d0b19772cf9af9b3ec0183000000000000004745542068747470733a2f2f6170692e782e636f6d2f312e312f6163636f756e742f73657474696e67732e6a736f6e20485454502f312e310d0a686f73743a206170692e782e636f6d0d0a636f6e6e656374696f6e3a20636c6f73650d0a0d0a0d0a0d0a0d0a6163636570742d656e636f64696e673a206964656e746974790d0a0d0a6705000000000000485454502f312e3120323030204f4b0d0a446174653a205765642c2030362041756720323032352030383a34373a303020474d540d0a436f6e74656e742d547970653a206170706c69636174696f6e2f6a736f6e3b636861727365743d7574662d380d0a5472616e736665722d456e636f64696e673a206368756e6b65640d0a436f6e6e656374696f6e3a20636c6f73650d0a43462d5241593a20393661643434356434643638666432642d53494e0d0a706572663a20373430323832373130340d0a707261676d613a206e6f2d63616368650d0a7374617475733a20323030204f4b0d0a657870697265733a205475652c203331204d617220313938312030353a30303a303020474d540d0a5365742d436f6f6b69653a206c616e673d656e3b20506174683d2f0d0a5365742d436f6f6b69653a205f5f63665f626d3d4963494742564e624a7763366a58624331584d344d6537756b37706536652e4b74482e696f3961476f35412d313735343437303032302d312e302e312e312d67484b4c7535557765776b6d46794a463832536665575045756e3147336a6d506c4b427743786f6f4d7a74666e6d34695734624d796f324c6965344d53485256337772354a76346f344765694741334d32486c713143456e346457355f43693777525f6a684b524632674d3b20706174683d2f3b20657870697265733d5765642c2030362d4175672d32352030393a31373a303020474d543b20646f6d61696e3d2e782e636f6d3b20487474704f6e6c793b205365637572650d0a43616368652d436f6e74726f6c3a206e6f2d63616368652c206e6f2d73746f72652c206d7573742d726576616c69646174652c207072652d636865636b3d302c20706f73742d636865636b3d300d0a6c6173742d6d6f6469666965643a205765642c2030362041756720323032352030383a34373a303020474d540d0a782d7472616e73616374696f6e3a20616634663766376435626266666163620d0a782d6163636573732d6c6576656c3a20726561642d77726974652d6469726563746d657373616765730d0a782d6672616d652d6f7074696f6e733a2053414d454f524947494e0d0a782d7472616e73616374696f6e2d69643a20616634663766376435626266666163620d0a782d7873732d70726f74656374696f6e3a20300d0a782d726174652d6c696d69742d6c696d69743a203130300d0a782d726174652d6c696d69742d72657365743a20313735343437303135340d0a636f6e74656e742d646973706f736974696f6e3a206174746163686d656e743b2066696c656e616d653d6a736f6e2e6a736f6e0d0a782d636c69656e742d6576656e742d656e61626c65643a20747275650d0a782d636f6e74656e742d747970652d6f7074696f6e733a206e6f736e6966660d0a782d726174652d6c696d69742d72656d61696e696e673a2039380d0a782d747769747465722d726573706f6e73652d746167733a20426f756e636572436f6d706c69616e740d0a7374726963742d7472616e73706f72742d73656375726974793a206d61782d6167653d3633313133383531393b20696e636c756465537562646f6d61696e730d0a782d726573706f6e73652d74696d653a2031380d0a782d636f6e6e656374696f6e2d686173683a20373264653964663436633138656235393261656363393831633039386330653561336266303737653137376435636664663762346534393537366439386435330d0a63662d63616368652d7374617475733a2044594e414d49430d0a766172793a206163636570742d656e636f64696e670d0a5365727665723a20636c6f7564666c617265207473615f700d0a0d0a3439390d0a2273637265656e5f6e616d65223a2268617a6d6f6c6172220d0a300d0a0d0a050000000000000000000000000000005e00000000000000dc00000000000000de00000000000000e003000000000000e2030000000000009004000000000000920400000000000009050000000000002805000000000000030000000000000000000000000000004805000000000000c605000000000000de05000000000000e109000000000000e8090000000000002805000000000000e80900000000000001020800000000000000000000000000000008000000000000000600000000000000010000000100000000000000000000000000000048050000000000006e36d3086e8fcf30889d11d12208d6130100000000000000010000000100000000000000e109000000000000e80900000000000022a5d4e6a90faf32a28de93db3229fc30300000000000000000000000100000000000000e003000000000000e203000000000000405b47add04f3f463321cdf186ad5b1f0700000000000000010000000100000000000000c605000000000000de0500000000000035cd091f1d0e9629efc5a59b314e776f0200000000000000000000000100000000000000900400000000000092040000000000008524031b26a42aed69dc1d191a2b15090500000000000000000000000100000000000000dc00000000000000de000000000000004d7ad5b2ce1aa2ed917cc28a64cd6d84040000000000000000000000010000000000000000000000000000005e000000000000006948f8f74c011d5d0547c673263be99a000000000000000000000000010000000000000009050000000000002805000000000000e3d70a58ac9f8c27641a1af27add0a4d0000000000000000';
  };

  runVerify: TRunVerify = async (presentationData, credentialGroupId) => {
    const userKey = await this.#db?.getUserKey();

    console.log('runnign runVerify: ', { userKey });
    if (userKey) {
      const identity = semaphore.createIdentity(userKey, credentialGroupId);

      try {
        const verification = await verifier.verify(
          '',
          presentationData,
          credentialGroupId,
          String(identity.commitment),
        );

        if (verification) {
          return verification;
        }
      } catch (err) {
        console.log({ err });
      }
    }
  };

  getProofs: TGetProofs = async (dropAddress, pointsRequired) => {
    const userKey = await this.#db?.getUserKey();
    console.log('runnign getProofs: ', { userKey });

    if (!userKey) {
      throw new Error('userKey is not available');
    }
    const semaphoreProofs: TSemaphoreProof[] = [];
    const availableTasks = tasks();
    let totalScore = 0;
    const verifications = await this.#db?.getVerifications();

    if (!verifications || verifications.length === 0) {
      throw new Error('no verifications found');
    }
    if (verifications) {
      for (let x = 0; x < verifications.length; x++) {
        const { credentialGroupId, status } = verifications[x];
        if (totalScore >= pointsRequired) {
          break;
        }
        if (status !== 'completed') {
          continue;
        }
        totalScore = totalScore + availableTasks[x].points;
        const identity = semaphore.createIdentity(userKey, credentialGroupId);
        const { commitment } = identity;

        const data = await semaphore.getProof(
          String(commitment),
          availableTasks[x].semaphoreGroupId,
        );

        if (!data) {
          throw new Error('no proof found');
        }

        const scope = calculateScope(dropAddress);

        const { merkleTreeDepth, merkleTreeRoot, message, points, nullifier } =
          await generateProof(identity, data as any, 'verification', scope);

        semaphoreProofs.push({
          credential_group_id: credentialGroupId,
          semaphore_proof: {
            merkle_tree_depth: merkleTreeDepth,
            merkle_tree_root: merkleTreeRoot,
            nullifier: nullifier,
            message: message,
            scope,
            points,
          },
        });
      }
    }

    return semaphoreProofs;
  };

  saveVerification: TSaveVerification = async (
    verificationData,
    credentialGroupId,
  ) => {
    const userKey = await this.#db?.getUserKey();
    console.log('running saveVerification: ', { userKey });

    if (userKey) {
      const identity = semaphore.createIdentity(userKey, credentialGroupId);

      try {
        const verification = await relayer.createVerification(
          credentialGroupId,
          verificationData.verifierMessage.idHash,
          String(identity.commitment),
          verificationData.signature,
        );
        return verification;
      } catch (err) {
        alert('Check Error in console');
        console.error(err);
      }
    }
  };
}

const manager = new Manager();
console.log({ manager });
export default manager;
